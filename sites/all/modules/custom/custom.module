<?php

//Function that returns latest nodeid 
function get_latest_nodeid(){
    $r = db_select('node','n')
    ->fields('n')
    ->orderBy('created','DESC')
    ->execute()
    ->fetchObject();
    return (int)$r->nid;
}

function get_specific_room_to_update(){
    $index=1;
    //dpm(get_latest_nodeid());
    $latest_node_id= (string)get_latest_nodeid();
    
    $res = db_query("SELECT name 
            FROM taxonomy_term_data AS ttd, field_data_field_roomname AS froom
            WHERE froom.field_roomname_tid = ttd.tid 
                AND froom.entity_id=$latest_node_id");
 
    $result = $res->fetchField();
    
  return(trim((explode("-",$result)[$index])));
}

function update_room_type(){
   // $room_name= get_specific_room_to_update();
    $latest_node_id= get_latest_nodeid()+"";
   
    $res = db_query("UPDATE field_data_field_room_type_for_filter
            SET field_room_type_for_filter_value = '$room_name'
            WHERE field_data_field_room_type_for_filter.entity_id = '$latest_node_id'");
}

function final_update(){
$room_name=$GLOBALS['room_name'];
$latest_node_id= get_latest_nodeid()+"";
    $res = db_query("UPDATE field_data_field_room_type_for_filter 
    SET field_room_type_for_filter_value ='gede'
            WHERE field_data_field_room_type_for_filter.entity_id = $latest_node_id");
}


function tid($room_name){
    $result = db_query("SELECT name,tid FROM taxonomy_term_data where name='$room_name'"); 
    $data = $result->fetchObject();
    return $data->tid;  
}

function get_one_status($start_time, $end_time) {
    $status = true;
    $GLOBALS['room_name']=$_GET["room_name"];
    $tid= tid($_GET["room_name"]);
    $res = db_query("SELECT entity_id,
            field_time_value, field_time_value2 
            FROM field_data_field_time AS time NATURAL JOIN field_data_field_roomname AS room
            WHERE room.field_roomname_tid = " . $tid);
    while($data = $res->fetchObject()){
	    $start = $data -> field_time_value;
	    $end = $data -> field_time_value2;
	    if(($start_time >= $start && $start_time <= $end) || 
	        ($end_time <= $end && $end_time >= $start)) {
	            $status = false;
	        }
	  }
    if($status) {
        return 'Available';
    }
    else {   
        return 'Booked';
    }
}

function insert_collisions(){
    global $user;
    $current_status=get_one_status($_GET["start_date"], $_GET["end_date"]);
    $room_name=$_GET['room_name'];
    $course_name =  $_GET["course_name"];
    $start_time=$_GET['start_date'];
    $end_time=$_GET['end_date'];
    $uid=(int)$user->uid;
    $GLOBALS['collision_id'] = $room_name; 
    $collision_id =$GLOBALS['collision_id'];
    
    if ($current_status!="Available"){
        $sql="INSERT INTO collision (user_id, course_name, room_name,start_time, end_time, collision_id, flag) VALUES ($uid, '$course_name' ,'$room_name' ,'$start_time', '$end_time', '$collision_id', 1)";
        $result = db_query($sql);
    }
}

function insert_other_collided_class(){
    global $user;
    $current_status=get_one_status($_GET["start_date"], $_GET["end_date"]);
    $room_name=$_GET['room_name'];
    $start_time=$_GET['start_date'];
    $end_time=$_GET['end_date'];
    $uid=(int)$user->uid;

    if ($current_status!="Available"){
            $all_room = array(); 
            $result = db_query("SELECT name,tid FROM taxonomy_term_data"); 
            while ($data=$result->fetchObject()){
                $all_room[]=$data->name;      
            }
            
            // Remove the booked classroom from the array 
        	$index = array_search($room_name, $all_room);
        	if ( $index !== false ) {
        		unset( $all_room[$index] );
        	}
        
        foreach ($all_room as $room){
            $tid= tid($room);
            $res = db_query("SELECT entity_id,
            field_time_value, field_time_value2 
            FROM field_data_field_time AS time NATURAL JOIN field_data_field_roomname AS room
            WHERE room.field_roomname_tid = " . $tid);
            
            while($data = $res->fetchObject()){
        	    $start = $data -> field_time_value;
        	    $end = $data -> field_time_value2;
        	    if(($start_time >= $start && $start_time <= $end) || 
        	        ($end_time <= $end && $end_time >= $start)) {
        	            //insertion query 
        	                global $user;
                            $room_name=$room;
                            $start_time=$_GET['start_date'];
                            $end_time=$_GET['end_date'];
                            $uid=(int)$user->uid;
                            $collision_id =$GLOBALS['collision_id'];
                            $sql="INSERT INTO collision (user_id,course_name, room_name,start_time, end_time, collision_id) VALUES ($uid,'$course_name','$room_name' ,'$start_time', '$end_time', '$collision_id')";
                            $result = db_query($sql);
	        }
    	  }
        }
        }
    }


function custom_views_query_alter(&$view, &$query) {
  // (Example assuming a view with an exposed filter on node title.)
  // If the input for the title filter is a positive integer, filter against
  // node ID instead of node title.
  if ($view->name == 'staff_collision_dashboard') {
    // Traverse through the 'where' part of the query.
    foreach ($query->where as &$condition_group) {
      foreach ($condition_group['conditions'] as &$condition) {

        // If this is the part of the query filtering on title, change the
        // condition to filter on node ID.
        if ($condition['field'] == 'node.title') {
          $condition = array(
            'field' => 'node.nid',
            'value' => $view->exposed_raw_input['title'],
            'operator' => '=',
          );
        }
      }
    }
  }
  
  else if ($view->name == 'book_room_calendar') {
      
    global $user;
    
    $arrayOfIds[] = array();
    
    $count = 0;

    if(check_role($user -> roles, "administrator") || check_role($user -> roles, "manager")) {
 
        $res = db_query("SELECT fdfcn.entity_id
                         FROM COURSE 
                         JOIN field_data_field_course_names as fdfcn ON CourseName = fdfcn.field_course_names_value");
    
    }

    else if(check_role($user -> roles, "staff") || check_role($user -> roles, "lead")) {
    
        $res = db_query("SELECT fdfcn.entity_id
                         FROM USER NATURAL JOIN TEACHES NATURAL JOIN COURSE 
                         JOIN field_data_field_cwid AS fdfc ON CWID = fdfc.field_cwid_value  
                         JOIN users AS U ON fdfc.entity_id = U.uid 
                         JOIN field_data_field_course_names as fdfcn ON CourseName = fdfcn.field_course_names_value
                         WHERE U.uid = '$user->uid'");
      
    }

    else {

        $res = db_query("SELECT fdfcn.entity_id
                         FROM USER NATURAL JOIN TAKES NATURAL JOIN COURSE 
                         JOIN field_data_field_cwid AS fdfc ON CWID = fdfc.field_cwid_value  
                         JOIN users AS U ON fdfc.entity_id = U.uid 
                         JOIN field_data_field_course_names as fdfcn ON CourseName = fdfcn.field_course_names_value
                         WHERE U.uid = '$user->uid'");
                        
    }
                         
    while($data = $res->fetchObject()){
        
	    $arrayOfIds[$count] = array(
	        
	        $data -> entity_id
	        
	        );
	        
	        $count++;
    
    }
    
    $query->add_where(1,'node.nid', $arrayOfIds, 'IN');

  }
  
}

function custom_form_alter(&$form, &$form_state, $form_id) {
    global $user;
    //If clause for the submit_room_request form
    if ($form_id=="submit_room_request_node_form"){
        $form['title']['#type'] = 'hidden';
        $form['title']['#value'] = "Room Request";
        $form['actions']['submit']['#value'] = 'Request Room';
        
        // Keeps the room type as NULL for the default and later updates its value 
        $form['field_room_type_for_filter']['#type']='hidden';
        $form['#submit'][] = 'custom_form_submit';
        
        $current_role=implode(',', $user->roles);        
        //Inserts the collided classrooms in collision table with their current userid

        if ($current_role=="authenticated user,staff" || $current_role=="authenticated user,administrator" || $current_role=="authenticated user,lead")
        {
           insert_collisions();
           //insert_other_collided_class();
           create_save_new_node($form,$form_state,$_GET["room_name"],$_GET["start_date"],$_GET["end_date"], $_GET["course_name"]);
        }
    }    
    
    if ($form_id=="search_node_form"){
        $form['title']['#type'] = 'hidden';
        //Changes save buttom name to search
        $form['actions']['submit']['#value'] = 'Search rooms';  
  }
  else {
      //drupal_set_message(t('This is a different page.'), 'error');
  }
}


function create_save_new_node(&$form, &$form_state,$room_name,$start_date,$end_date, $course_name){
  global $user;
  $current_status=get_one_status($_GET["start_date"], $_GET["end_date"]);
  
  $newNode = new stdClass();
  $newNode->type = 'submit_room_request';
  node_object_prepare($newNode);
  $newNode->title = "Room_request";
  $newNode->uid = $user->uid;
  $newNode->created = strtotime("now");
  $newNode->changed = strtotime("now");
  
  if ($current_status!='Available'){
    $newNode->status = 0;
  }
  else{
    $newNode->status = 1;
  }
  $newNode->comment = 0;
  $newNode->promote = 0;
  $newNode->moderate = 0;
  $newNode->sticky = 0;
  $newNode->language = 'und';
  
  
  
  $stmt = db_query("SELECT tid FROM taxonomy_term_data WHERE name ='$room_name'");
  $data = $stmt->fetchObject();
  $tid = $data -> tid;
  $newNode->field_roomname['und'][0]['tid']= $tid;
  $newNode->field_room_type_for_filter['und'][0]['value'] = trim((explode("-",$room_name)[1]));;
  $newNode->field_time['und'][0]['value']= $start_date;
  $newNode->field_time['und'][0]['value2']= $end_date;
  $newNode->field_course_names['und'][0]['value'] = $course_name;
  node_save($newNode);
  
  
  
  if ($current_status !='Booked'){
    drupal_set_message("Succefully requested $room_name");
  }
  
  else {
    drupal_set_message("Conflict with $room_name. Manager will resolve this conflict",'warning');
    drupal_set_message("$room_name will show up in your calendar after your request is accepted. Go to Collided Rooms for more details",'warning');
  }
  
  drupal_goto("staff/dashboard");
}


function custom_form_submit($form, &$form_state) {
   // $gg=(int)get_latest_nodeid();
   //  drupal_set_message(t('lastest node id'.$gg));
    //update_room_type();
       // drupal_set_message(t('gggg The room type is updated'));
}