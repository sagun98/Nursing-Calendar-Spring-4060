<?php
function manager_redirect_menu() {
  $items = array();
  $items['manager/redirect'] = array( //this creates a URL that will call this form at "examples/form-example"
    'title' => 'Manager redirect Dashboard', //page title
    'description' => 'A redirection page for managing collisions',
    'page callback' => 'drupal_get_form', //this is the function that will be called when the page is accessed.  for a form, use drupal_get_form
    'page arguments' => array('manager_redirect_form'), //put the name of the form here
    'access arguments' => array('view_collision_dashboard')
  );
  return $items;
}


function manager_redirect_form($form, &$form_state) {
    $room_name =$_GET['room_name'];
    $stt = db_query("SELECT tid FROM taxonomy_term_data WHERE name='$room_name'"); 
    $data_1=$stt->fetchObject();
    $tid= $data_1->tid;
    $nid= get_nid($tid, $_GET['start_date'],$_GET['end_date'],$_GET['uid'],$_GET['course_id'] );
    //dpm($nid);
  
    //dpm (node_load($nid));
    $node = node_load($nid);
    $node->status =1;
    node_save($node);
  
  
    $collision_id = $_GET['collision_id'];
    $node1= node_load($collision_id);
    $node1->status =0;
    node_save($node1);
   
    delete_collision($collision_id);
  
    drupal_goto("manager/dashboard");
    return $form;
  
  
}


function redirect_collided_classroom(&$form_state){
  
}

function delete_collision($collision_id){
    $del = db_query("DELETE FROM collision
    WHERE collision_id=$collision_id");
}

function get_nid($tid, $start_time,$end_time,$uid,$crn ){

        $sel= db_query("SELECT n.uid,n.nid
            FROM node as n, field_data_field_roomname as rn,
            field_data_field_time as t, field_data_field_course_id AS crn
            WHERE n.status = 0
            AND n.type = 'submit_room_request'
            AND n.nid = rn.entity_id
            AND rn.field_roomname_tid = $tid
            AND n.nid = t.entity_id
            AND '$start_time'= t.field_time_value
        	AND '$end_time'= t.field_time_value2
        	AND n.uid = $uid
        	AND n.nid = crn.entity_id
        	AND crn.field_course_id_value = $crn");
	    $selec = $sel->fetchObject();
	    return $selec->nid;
}
    
    
?>